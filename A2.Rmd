---
title: "A2"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(tidytext)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(ggpubr)
library(splines)
library(mgcv)
library(kableExtra)
library(httr)
library(jsonlite)
library(purrr)
library(ggcorrplot)
library(scales)
library(tm)
library(SnowballC)
library(wordcloud2)
library(slam)
```


```{r}
census_16_metro <- read.csv("census_16_metro.csv")
census_16_other <- read.csv("census_16_other.csv")
census_21_metro <- read.csv("census_21_metro.csv")
census_21_other <- read.csv("census_21_other.csv")
```

```{r}
library(sf)

# Load shapefile from the same folder
canada_provinces_sf <- st_read("Canada_Provinces.shp")

```



```{r}
housing_cols <- c(
  "PR", "CMA", "Tenur", "SHELCO", "VALUE", 
  "HHInc_AT", "TotInc_AT", "HHSIZE", 
  "MarStH", "HCORENEED_IND", "WEIGHT"
)

housing_16 <- census_16_metro %>% select(any_of(housing_cols))
housing_21 <- census_21_metro %>% select(any_of(housing_cols))


aging_cols <- c(
  "PR", "CMA", "AGEGRP", "Sex", "MarStH",
  "HHSIZE", "GENSTAT", "EmpIn", "HDGREE", "WEIGHT"
)

aging_16 <- census_16_metro %>% select(any_of(aging_cols))
aging_21 <- census_21_metro %>% select(any_of(aging_cols))


education_cols <- c(
  "PR", "CMA", "Sex", "IMMSTAT", "HDGREE", 
  "GENSTAT", "COW", "TotInc_AT", "Wages", 
  "HHInc_AT", "WEIGHT"
)

education_16 <- census_16_metro %>% select(any_of(education_cols))
education_21 <- census_21_metro %>% select(any_of(education_cols))


immigration_cols <- c(
  "PR", "CMA", "IMMSTAT", "IMMCAT5", "YRIMM", 
  "POB", "VisMin", "Citizen", "Tenur", 
  "HHInc_AT", "TotInc_AT", "WEIGHT"
)

immigration_16 <- census_16_metro %>% select(any_of(immigration_cols))
immigration_21 <- census_21_metro %>% select(any_of(immigration_cols))

```

```{r}
# Function to remove NAs and outliers
clean_census_data <- function(df) {
  df %>%
    # 1. Remove rows with missing values in any column
    drop_na() %>%
    
    # 2. Remove numeric outliers beyond 1.5×IQR range
    mutate(across(
      where(is.numeric),
      ~ {
        q1 <- quantile(., 0.25, na.rm = TRUE)
        q3 <- quantile(., 0.75, na.rm = TRUE)
        iqr <- q3 - q1
        lower <- q1 - 1.5 * iqr
        upper <- q3 + 1.5 * iqr
        ifelse(. < lower | . > upper, NA, .)
      }
    )) %>%
    drop_na()
}

# Apply cleaning to all datasets
housing_16_clean <- clean_census_data(housing_16)
housing_21_clean <- clean_census_data(housing_21)

aging_16_clean <- clean_census_data(aging_16)
aging_21_clean <- clean_census_data(aging_21)

education_16_clean <- clean_census_data(education_16)
education_21_clean <- clean_census_data(education_21)

immigration_16_clean <- clean_census_data(immigration_16)
immigration_21_clean <- clean_census_data(immigration_21)
```


```{r}
summarize_dataset <- function(df, name = "Dataset") {
  cat("\n--- Summary of", name, "---\n")
  
  # 1. Rows and columns
  cat("Number of rows:", nrow(df), "\n")
  cat("Number of columns:", ncol(df), "\n\n")
  
  # 2. Missing values per column
  na_summary <- sapply(df, function(x) sum(is.na(x)))
  cat("Missing values per column:\n")
  print(na_summary)
  cat("\n")
  
  # 3. Numeric summary
  num_cols <- df %>% select(where(is.numeric))
  if (ncol(num_cols) > 0) {
    cat("Numeric column summary:\n")
    print(summary(num_cols))
    cat("\n")
  }
  
  # 4. Categorical summary
  cat_cols <- df %>% select(where(~!is.numeric(.)))
  if (ncol(cat_cols) > 0) {
    cat("Categorical column value counts:\n")
    for (col in names(cat_cols)) {
      cat("\nColumn:", col, "\n")
      print(table(cat_cols[[col]]))
    }
  }
}


# Housing
summarize_dataset(housing_16_clean, "Housing 2016")
summarize_dataset(housing_21_clean, "Housing 2021")

# Aging
summarize_dataset(aging_16_clean, "Aging 2016")
summarize_dataset(aging_21_clean, "Aging 2021")

# Education
summarize_dataset(education_16_clean, "Education 2016")
summarize_dataset(education_21_clean, "Education 2021")

# Immigration
summarize_dataset(immigration_16_clean, "Immigration 2016")
summarize_dataset(immigration_21_clean, "Immigration 2021")

```

```{r}
library(dplyr)

# -----------------------------
# 1️⃣ Housing datasets
# -----------------------------
housing_16_clean <- housing_16_clean %>%
  rename(
    Tenure = Tenur,
    Shelter_Cost = SHELCO,
    Household_Income = HHInc_AT,
    Total_Income = TotInc_AT,
    Household_Size = HHSIZE,
    Marital_Status = MarStH,
    Core_Housing_Need = HCORENEED_IND
  )

housing_21_clean <- housing_21_clean %>%
  rename(
    Shelter_Cost = SHELCO,
    Household_Income = HHInc_AT,
    Total_Income = TotInc_AT,
    Household_Size = HHSIZE,
    Core_Housing_Need = HCORENEED_IND
  )

# -----------------------------
# 2️⃣ Aging datasets
# -----------------------------
aging_16_clean <- aging_16_clean %>%
  rename(
    Age_Group = AGEGRP,
    Gender = Sex,
    Marital_Status = MarStH,
    Household_Size = HHSIZE,
    Labour_Force_Status = GENSTAT,
    Employment_Income = EmpIn,
    Education_Level = HDGREE
  )

aging_21_clean <- aging_21_clean %>%
  rename(
    Age_Group = AGEGRP,
    Household_Size = HHSIZE,
    Labour_Force_Status = GENSTAT,
    Employment_Income = EmpIn,
    Education_Level = HDGREE
  )

# -----------------------------
# 3️⃣ Education datasets
# -----------------------------
education_16_clean <- education_16_clean %>%
  rename(
    Gender = Sex,
    Immigration_Status = IMMSTAT,
    Education_Level = HDGREE,
    Labour_Force_Status = GENSTAT,
    Class_of_Worker = COW,
    Total_Income = TotInc_AT,
    Wages = Wages,
    Household_Income = HHInc_AT
  )

education_21_clean <- education_21_clean %>%
  rename(
    Immigration_Status = IMMSTAT,
    Education_Level = HDGREE,
    Labour_Force_Status = GENSTAT,
    Class_of_Worker = COW,
    Total_Income = TotInc_AT,
    Wages = Wages,
    Household_Income = HHInc_AT
  )

# -----------------------------
# 4️⃣ Immigration datasets
# -----------------------------
immigration_16_clean <- immigration_16_clean %>%
  rename(
    Immigration_Status = IMMSTAT,
    Immigration_Category = IMMCAT5,
    Year_Immigrated = YRIMM,
    Place_of_Birth = POB,
    Visible_Minority = VisMin,
    Citizenship = Citizen,
    Tenure = Tenur,
    Household_Income = HHInc_AT,
    Total_Income = TotInc_AT
  )

immigration_21_clean <- immigration_21_clean %>%
  rename(
    Immigration_Status = IMMSTAT,
    Immigration_Category = IMMCAT5,
    Year_Immigrated = YRIMM,
    Place_of_Birth = POB,
    Citizenship = Citizen,
    Household_Income = HHInc_AT,
    Total_Income = TotInc_AT
  )

```



```{r}
library(dplyr)
library(ggplot2)
library(tidyr)

# Combine 2016 and 2021 datasets
housing_all <- bind_rows(
  housing_16_clean %>% mutate(Year = 2016),
  housing_21_clean %>% mutate(Year = 2021)
)

# -----------------------------
# 1️⃣ Bar chart: Median shelter cost vs median household income
# -----------------------------
housing_median <- housing_all %>%
  group_by(Year) %>%
  summarise(
    Median_Shelter = median(Shelter_Cost, na.rm = TRUE),
    Median_Income = median(Household_Income, na.rm = TRUE)
  )

ggplot(housing_median, aes(x = factor(Year))) +
  geom_bar(aes(y = Median_Shelter), stat = "identity", fill = "steelblue", alpha = 0.7) +
  geom_point(aes(y = Median_Income), color = "red", size = 3) +
  geom_line(aes(y = Median_Income, group = 1), color = "red", linetype = "dashed") +
  labs(
    title = "Median Shelter Cost vs Median Household Income",
    y = "CAD ($)",
    x = "Year",
    caption = "Blue bars = Shelter cost, Red line = Household income"
  ) +
  theme_minimal()

# -----------------------------
# 2️⃣ Map: Change in shelter-cost-to-income ratio by province
# -----------------------------
# Compute change per province
housing_province <- housing_all %>%
  group_by(PR, Year) %>%
  summarise(Median_Shelter_Income_Ratio = median(Shelter_Cost / Household_Income, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Year, values_from = Median_Shelter_Income_Ratio) %>%
  mutate(
    Change = `2021` - `2016`,
    PR = str_pad(PR, width = 2, side = "left", pad = "0")  # pad to match shapefile
  )

# Join with shapefile
map_data_housing <- canada_provinces_sf %>%
  left_join(housing_province, by = c("PRUID" = "PR"))

# Plot
ggplot(map_data_housing) +
  geom_sf(aes(fill = Change)) +
  scale_fill_gradient2(low = "green", mid = "white", high = "red", midpoint = 0) +
  labs(title = "Change in Shelter Cost-to-Income Ratio by Province (2016–2021)") +
  theme_minimal()
# -----------------------------
# 3️⃣ Stacked bar: % of renters vs owners by income group
# -----------------------------
housing_income_group <- housing_all %>%
  mutate(
    Income_Quartile = ntile(Household_Income, 4),
    Tenure = factor(Tenure, labels = c("Owner", "Renter"))
  ) %>%
  group_by(Year, Income_Quartile, Tenure) %>%
  summarise(Count = n(), .groups = "drop") %>%
  group_by(Year, Income_Quartile) %>%
  mutate(Pct = Count / sum(Count) * 100)

ggplot(housing_income_group, aes(x = factor(Income_Quartile), y = Pct, fill = Tenure)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Year) +
  labs(
    title = "Renters vs Owners by Household Income Quartile",
    x = "Income Quartile",
    y = "Percentage",
    fill = "Tenure"
  ) +
  theme_minimal()

# -----------------------------
# 4️⃣ Scatter plot: Change in average housing price vs change in median income
# -----------------------------
# Compute median household income change per province
income_change <- housing_all %>%
  group_by(PR, Year) %>%
  summarise(Median_Income = median(Household_Income, na.rm = TRUE)) %>%
  pivot_wider(names_from = Year, values_from = Median_Income) %>%
  mutate(Median_Income_Change = `2021` - `2016`)

# Assume external CMHC home price data is merged into 'housing_change' dataframe
# with columns: PROVINCE, Price_Change
# Example scatter plot:
# ggplot(housing_change, aes(x = Price_Change, y = Median_Income_Change, label = PROVINCE)) +
#   geom_point(color = "steelblue", size = 3) +
#   geom_text(vjust = -0.5) +
#   labs(
#     title = "Change in Average Housing Price vs Change in Median Income by Province",
#     x = "Average Home Price Change ($)",
#     y = "Median Household Income Change ($)"
#   ) +
#   theme_minimal()

```







```{r}
library(dplyr)
library(ggplot2)
library(sf)
library(stringr)

# Combine 2016 and 2021 datasets
aging_all <- bind_rows(
  aging_16_clean %>% mutate(Year = 2016),
  aging_21_clean %>% mutate(Year = 2021)
)

# -----------------------------
# 1️⃣ Population Pyramid: Age distribution by gender
# -----------------------------
pyramid_data <- aging_all %>%
  filter(!is.na(Age_Group) & !is.na(Gender)) %>%
  group_by(Year, Age_Group, Gender) %>%
  summarise(Count = n(), .groups = "drop") %>%
  mutate(Count = ifelse(Gender == "Male", -Count, Count)) # Negative for males

ggplot(pyramid_data, aes(x = Age_Group, y = Count, fill = Gender)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Year) +
  coord_flip() +
  labs(
    title = "Population Pyramid by Age Group and Gender",
    x = "Age Group",
    y = "Population Count",
    fill = "Gender"
  ) +
  theme_minimal()

# -----------------------------
# 2️⃣ Map: % of seniors (65+) by province
# -----------------------------
# 1️⃣ Convert PR to character with leading zeros
seniors_province <- aging_all %>%
  filter(Age_Group %in% 6:10) %>%
  group_by(PR, Year) %>%
  summarise(Seniors = n(), .groups = "drop") %>%
  left_join(
    aging_all %>%
      group_by(PR, Year) %>%
      summarise(Total = n(), .groups = "drop"),
    by = c("PR","Year")
  ) %>%
  mutate(
    Senior_Percent = Seniors / Total * 100,
    PR = str_pad(PR, width = 2, side = "left", pad = "0")  # convert to "01", "02", etc.
  )

# 2️⃣ Merge with shapefile
map_data <- canada_provinces_sf %>%
  left_join(
    seniors_province %>% filter(Year == 2021) %>% select(PR, Senior_Percent),
    by = c("PRUID" = "PR")
  )

# 3️⃣ Plot map
ggplot(map_data) +
  geom_sf(aes(fill = Senior_Percent)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Percentage of Seniors (65+) by Province (2021)") +
  theme_minimal()

# -----------------------------
# 3️⃣ Line/Bar Chart: Senior dependency ratio (65+/15-64)
# -----------------------------
dependency_ratio <- aging_all %>%
  mutate(
    Age_Group_Simple = case_when(
      Age_Group %in% 6:18 ~ "Working_Age",
      Age_Group %in% 19:21 ~ "Seniors",
      TRUE ~ NA_character_
    )
  ) %>%
  filter(!is.na(Age_Group_Simple)) %>%
  group_by(PR, Year, Age_Group_Simple) %>%
  summarise(Count = n(), .groups = "drop") %>%
  pivot_wider(names_from = Age_Group_Simple, values_from = Count) %>%
  mutate(Senior_Dependency_Ratio = Seniors / Working_Age)

# Plot
ggplot(dependency_ratio, aes(x = PR, y = Senior_Dependency_Ratio, fill = factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Senior Dependency Ratio by Province (65+/15-64)",
    x = "Province",
    y = "Senior Dependency Ratio",
    fill = "Year"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# -----------------------------
# 4️⃣ Scatter Plot: % seniors vs healthcare worker density
# -----------------------------
# Requires external CIHI data with columns: PROVINCE, Healthcare_Workers_Per_1000
# Example:
# seniors_percent <- aging_all %>%
#   filter(Age_Group %in% c("65-69","70-74","75-79","80-84","85+")) %>%
#   group_by(PROVINCE, Year) %>%
#   summarise(Seniors = n()) %>%
#   left_join(
#     aging_all %>% group_by(PROVINCE, Year) %>% summarise(Total = n()),
#     by = c("PROVINCE","Year")
#   ) %>%
#   mutate(Senior_Percent = Seniors / Total * 100)
#
# merged_data <- seniors_percent %>%
#   left_join(healthcare_data, by = "PROVINCE") # healthcare_data from CIHI
#
# ggplot(merged_data, aes(x = Healthcare_Workers_Per_1000, y = Senior_Percent, label = PROVINCE)) +
#   geom_point(color = "steelblue", size = 3) +
#   geom_text(vjust = -0.5) +
#   labs(
#     title = "Senior Population vs Healthcare Worker Density",
#     x = "Healthcare Workers per 1000 population",
#     y = "Percentage of Seniors (65+)"
#   ) +
#   theme_minimal()
```
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)

# Map Education_Level to categories
education_all <- education_all %>%
  mutate(
    EduLevel = case_when(
      Education_Level %in% 1:2 ~ "High school or less",
      Education_Level %in% 3:5 ~ "Postsecondary non-university",
      Education_Level %in% 6:13 ~ "University",
      TRUE ~ NA_character_
    ),
    Gender = case_when(
      Gender == 1 ~ "Male",
      Gender == 2 ~ "Female",
      TRUE ~ NA_character_
    )
  )

# -----------------------------
# 1️⃣ Bar chart: % with University degree by year
# -----------------------------
edu_summary <- education_all %>%
  mutate(University = ifelse(EduLevel == "University", 1, 0)) %>%
  group_by(Year) %>%
  summarise(Pct_University = mean(University, na.rm = TRUE) * 100)

ggplot(edu_summary, aes(x = factor(Year), y = Pct_University, fill = factor(Year))) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  labs(
    title = "Percentage with University Degree (2016 vs 2021)",
    x = "Year",
    y = "Percentage (%)"
  ) +
  theme_minimal()

# -----------------------------
# 2️⃣ Boxplot: Income by education level
# -----------------------------
ggplot(education_all, aes(x = EduLevel, y = Total_Income)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  facet_wrap(~Year) +
  labs(
    title = "Income by Education Level (2016 vs 2021)",
    x = "Education Level",
    y = "Total Income ($)"
  ) +
  theme_minimal()

# -----------------------------
# 3️⃣ Map: % with University degree by province
# -----------------------------
edu_province <- education_all %>%
  mutate(University = ifelse(EduLevel == "University", 1, 0)) %>%
  group_by(PR, Year) %>%
  summarise(Pct_University = mean(University, na.rm = TRUE) * 100, .groups = "drop")

map_data_edu <- canada_provinces_sf %>%
  left_join(
    edu_province %>% filter(Year == 2021) %>% select(PR, Pct_University) %>%
      mutate(PR = str_pad(PR, width = 2, side = "left", pad = "0")),
    by = c("PRUID" = "PR")
  )

ggplot(map_data_edu) +
  geom_sf(aes(fill = Pct_University)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Percentage with University Degree by Province (2021)") +
  theme_minimal()

# -----------------------------
# 4️⃣ Gender income gap by education level
# -----------------------------
gender_income <- education_all %>%
  filter(!is.na(Gender) & !is.na(EduLevel)) %>%
  group_by(Year, EduLevel, Gender) %>%
  summarise(Median_Income = median(Total_Income, na.rm = TRUE), .groups = "drop") %>%
  pivot_wider(names_from = Gender, values_from = Median_Income) %>%
  mutate(Gender_Income_Gap = Male - Female)

ggplot(gender_income, aes(x = EduLevel, y = Gender_Income_Gap, fill = factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Gender Income Gap by Education Level (Median Income, 2016 vs 2021)",
    x = "Education Level",
    y = "Income Gap (Male - Female $)",
    fill = "Year"
  ) +
  theme_minimal()


```
```{r}
library(dplyr)
library(ggplot2)
library(tidyr)
library(stringr)

# Combine datasets
immigration_all <- bind_rows(
  immigration_16_clean %>% mutate(Year = 2016),
  immigration_21_clean %>% mutate(Year = 2021)
)

# Map Immigration_Status if numeric (1=Canadian-born, 2=Immigrant)
immigration_all <- immigration_all %>%
  mutate(Immigrant = case_when(
    Immigration_Status == 1 ~ "Canadian-born",
    Immigration_Status == 2 ~ "Immigrant",
    TRUE ~ NA_character_
  ))

```

```{r}
# Compute % immigrants by province
imm_province <- immigration_all %>%
  group_by(PR, Year) %>%
  summarise(Pct_Immigrant = mean(Immigrant == "Immigrant", na.rm = TRUE) * 100, .groups = "drop")

# Merge with shapefile
map_data_imm <- canada_provinces_sf %>%
  left_join(
    imm_province %>% filter(Year == 2021) %>% select(PR, Pct_Immigrant) %>%
      mutate(PR = str_pad(PR, width = 2, side = "left", pad = "0")),
    by = c("PRUID" = "PR")
  )

# Plot
ggplot(map_data_imm) +
  geom_sf(aes(fill = Pct_Immigrant)) +
  scale_fill_viridis_c(option = "plasma") +
  labs(title = "Percentage of Immigrants by Province (2021)") +
  theme_minimal()

```


```{r}
income_imm <- immigration_all %>%
  filter(!is.na(Total_Income) & !is.na(Immigrant)) %>%
  group_by(Year, Immigrant) %>%
  summarise(Median_Income = median(Total_Income, na.rm = TRUE), .groups = "drop")

ggplot(income_imm, aes(x = Immigrant, y = Median_Income, fill = factor(Year))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Median Income by Immigration Status (2016 vs 2021)",
    x = "Immigration Status",
    y = "Median Total Income ($)",
    fill = "Year"
  ) +
  theme_minimal()

```

```{r}
# Map Tenur numeric codes to Owned/Rented
immigration_all <- immigration_all %>%
  mutate(Tenure = case_when(
    Tenure == 1 ~ "Owned",
    Tenure == 2 ~ "Rented",
    TRUE ~ NA_character_
  ))

# Compute percentages for stacked bar
tenure_imm <- immigration_all %>%
  filter(!is.na(Tenure) & !is.na(Immigrant)) %>%
  group_by(Year, Immigrant, Tenure) %>%
  summarise(N = n(), .groups = "drop") %>%
  group_by(Year, Immigrant) %>%
  mutate(Pct = N / sum(N) * 100)

# Plot
ggplot(tenure_imm, aes(x = Immigrant, y = Pct, fill = Tenure)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Year) +
  labs(
    title = "Housing Tenure by Immigration Status (2016 vs 2021)",
    x = "Immigration Status",
    y = "Percentage (%)",
    fill = "Tenure"
  ) +
  theme_minimal()


```

```{r}
# Make sure you have housing data with province codes
# Example using housing_21_clean (merge on PR)
imm_housing <- immigration_all %>%
  filter(Year == 2021) %>%
  group_by(PR) %>%
  summarise(Pct_Immigrant = mean(Immigrant == "Immigrant", na.rm = TRUE) * 100) %>%
  left_join(
    housing_21_clean %>%
      group_by(PR) %>%
      summarise(Median_Shelter_Cost = median(Shelter_Cost, na.rm = TRUE)),
    by = "PR"
  )

ggplot(imm_housing, aes(x = Pct_Immigrant, y = Median_Shelter_Cost)) +
  geom_point(color = "steelblue", size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(
    title = "Immigrant Share vs Median Shelter Cost by Province (2021)",
    x = "% Immigrant",
    y = "Median Shelter Cost ($)"
  ) +
  theme_minimal()

```

