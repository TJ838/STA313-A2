---
title: "A1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(data.table)
library(tidytext)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(ggpubr)
library(splines)
library(mgcv)
library(kableExtra)
library(httr)
library(jsonlite)
library(purrr)
library(ggcorrplot)
library(scales)
library(tm)
library(SnowballC)
library(wordcloud2)
library(slam)
```



```{r}
census_21_metro <- read.csv("C:\\Users\\Taiyi Jin\\Desktop\\census_21_metro.csv",
                            header = TRUE,
                            stringsAsFactors = FALSE)
census_16_metro <- read.csv("C:\\Users\\Taiyi Jin\\Desktop\\census_16_metro.csv",
                            header = TRUE,
                            stringsAsFactors = FALSE)

```

```{r}

library(dplyr)

census_21_filtered <- census_21_metro %>%
  select(
    income = TotInc,
    indigenous = ABOID,
    gender = Gender
  )

census_16_filtered <- census_16_metro %>%
  select(
    income = TotInc,
    indigenous = ABOID,
    gender = Sex
  )




```



```{r}
library(dplyr)

census_21_clean <- census_21_filtered %>%
  mutate(
    income_clean = ifelse(income < 0 | income >= 1e7, NA, income)  # drop invalids
  )

census_16_clean <- census_16_filtered %>%
  mutate(
    income_clean = ifelse(income < 0 | income >= 1e7, NA, income)  # drop invalids
  )

# Winsorize at 99th percentile (optional)
p99_21 <- quantile(census_21_clean$income_clean, 0.99, na.rm = TRUE)
census_21_clean <- census_21_clean %>%
  mutate(income_clean = ifelse(income_clean > p99_21, p99_21, income_clean))

p99_16 <- quantile(census_16_clean$income_clean, 0.99, na.rm = TRUE)
census_16_clean <- census_16_clean %>%
  mutate(income_clean = ifelse(income_clean > p99_16, p99_16, income_clean))




```

```{r}
census_21_clean <- census_21_filtered %>%
  mutate(
    income_clean = ifelse(income < 0 | income > 1e6, NA, income)  # remove invalid extremes
  ) %>%
  filter(!is.na(income_clean))  # drop NAs for plotting

census_16_clean <- census_16_filtered %>%
  mutate(
    income_clean = ifelse(income < 0 | income > 1e6, NA, income)  # remove invalid extremes
  ) %>%
  filter(!is.na(income_clean))  # drop NAs for plotting

```

```{r}
p99_21 <- quantile(census_21_clean$income_clean, 0.99)
census_21_clean <- census_21_clean %>%
  mutate(income_clean = ifelse(income_clean > p99_21, p99_21, income_clean))


income_summary_21 <- census_21_clean %>%
  group_by(indigenous, gender) %>%
  summarize(median_income = median(income_clean, na.rm = TRUE), .groups = "drop")


p99_16 <- quantile(census_16_clean$income_clean, 0.99)
census_16_clean <- census_16_clean %>%
  mutate(income_clean = ifelse(income_clean > p99_16, p99_16, income_clean))


income_summary_16 <- census_16_clean %>%
  group_by(indigenous, gender) %>%
  summarize(median_income = median(income_clean, na.rm = TRUE), .groups = "drop")

```



```{r}
census_21_clean <- census_21_clean %>%
  mutate(
    indigenous = factor(indigenous,
                        levels = 1:6,
                        labels = c("First Nations",
                                   "Métis",
                                   "Inuk (Inuit)",
                                   "Multiple Aboriginal responses",
                                   "Aboriginal responses not included elsewhere",
                                   "Non-Aboriginal")),
    gender = factor(gender, levels = c(1, 2), labels = c("Male", "Female"))
  )

census_16_clean <- census_16_clean %>%
  mutate(
    indigenous = factor(indigenous,
                        levels = 1:6,
                        labels = c("First Nations",
                                   "Métis",
                                   "Inuk (Inuit)",
                                   "Multiple Aboriginal responses",
                                   "Aboriginal responses not included elsewhere",
                                   "Non-Aboriginal")),
    gender = factor(gender, levels = c(1, 2), labels = c("Male", "Female"))
  )



```

```{r}
income_summary_2021 <- census_21_clean %>%
  group_by(gender, indigenous) %>%
  summarize(median_income = median(income, na.rm = TRUE), .groups = "drop")

income_summary_2016 <- census_16_clean %>%
  group_by(gender, indigenous) %>%
  summarize(median_income = median(income, na.rm = TRUE), .groups = "drop")

```


```{r}
max_income <- max(c(income_summary_2016$median_income,
                    income_summary_2021$median_income))
```







```{r}
library(ggplot2)
library(scales)  # for the number formatting

# Define colors
colors <- c(
  "First Nations" = "#2E8B57",
  "Métis" = "#3e499f",
  "Inuk (Inuit)" = "#67a516",
  "Multiple Aboriginal responses" = "#48D1CC",
  "Aboriginal responses not included elsewhere" = "#5F9EA0",
  "Non-Aboriginal" = "#d51c1c"
)

ggplot(income_summary_2021, aes(x = indigenous, y = median_income, fill = indigenous)) +
  geom_col(position = position_dodge(width = 0.8)) +
  coord_cartesian(ylim = c(0, max_income)) +
  geom_text(aes(label = paste0(median_income/1000, "k")),  # convert to 'k'
            position = position_dodge(width = 0.8), 
            vjust = -0.5, size = 5) +  # increased text size
  facet_wrap(~ gender, ncol = 2) +
  scale_fill_manual(values = colors) +
  scale_y_continuous(labels = function(x) paste0(x/1000, "k")) +  # y-axis in 'k'
  labs(
    title = "Are Income Levels for Indigenous Peoples in Canada Improving Over Time from 2016 to 2021?",
    x = NULL,
    y = "Median Income ($)",
    fill = "Indigenous Group"
  ) +
  theme_minimal(base_size = 14) +
theme(
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.text.y = element_text(size = 12),
  axis.title.y = element_text(size = 14),
  strip.text = element_text(size = 14, face = "bold"),
  legend.title = element_text(size = 14),
  legend.text = element_text(size = 12),
  plot.title = element_text(size = 16, face = "bold"),
  panel.spacing = unit(0.5, "cm"),
  legend.position = "right",
  panel.grid.major.x = element_blank(),   # remove verticals
  panel.grid.minor.x = element_blank()    # remove verticals
)



```





```{r}
# Save a wider plot
ggsave("median_income_plot_21.png",
       width = 12,      # increase width
       height = 6,      # adjust height as needed
       dpi = 300)

```





```{r}
library(ggplot2)
library(scales)  # for the number formatting

# Define colors
colors <- c(
  "First Nations" = "#2E8B57",
  "Métis" = "#3e499f",
  "Inuk (Inuit)" = "#67a516",
  "Multiple Aboriginal responses" = "#48D1CC",
  "Aboriginal responses not included elsewhere" = "#5F9EA0",
  "Non-Aboriginal" = "#d51c1c"
)

ggplot(income_summary_2016, aes(x = indigenous, y = median_income, fill = indigenous)) +
  geom_col(position = position_dodge(width = 0.8)) +
  coord_cartesian(ylim = c(0, max_income)) +
  geom_text(aes(label = paste0(median_income/1000, "k")),  # convert to 'k'
            position = position_dodge(width = 0.8), 
            vjust = -0.5, size = 5) +  # increased text size
  facet_wrap(~ gender, ncol = 2) +
  scale_fill_manual(values = colors) +
  scale_y_continuous(labels = function(x) paste0(x/1000, "k")) +  # y-axis in 'k'
  labs(
    title = "Median Income by Indigenous Group and Gender in Metropolitan Areas (2016 Census)",
    x = NULL,
    y = "Median Income ($)",
    fill = "Indigenous Group"
  ) +
  theme_minimal(base_size = 14) +  # sets general base font size
theme(
  axis.text.x = element_blank(),
  axis.ticks.x = element_blank(),
  axis.text.y = element_text(size = 12),
  axis.title.y = element_text(size = 14),
  strip.text = element_text(size = 14, face = "bold"),
  legend.title = element_text(size = 14),
  legend.text = element_text(size = 12),
  plot.title = element_text(size = 16, face = "bold"),
  panel.spacing = unit(0.5, "cm"),
  legend.position = "right",
  panel.grid.major.x = element_blank(),   # remove verticals
  panel.grid.minor.x = element_blank()    # remove verticals
)

```


```{r}
# Save a wider plot
ggsave("median_income_plot_16.png",
       width = 12,      # increase width
       height = 6,      # adjust height as needed
       dpi = 300)

```







